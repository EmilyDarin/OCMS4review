---
output: 
    html_document:
        code_folding: hide
        css: styles.css
---

# Evaluation of OC MS4 monitoring program, mass emissions {.tabset}

```{r setup, message = F, warning = F, results = 'hide'}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, fig.path = 'figs/', dev.args = list(family = 'serif'))

library(tidyverse)
library(sf)
library(mapview)
library(lubridate)
library(leafsync)
library(viridisLite)
library(lubridate)
library(patchwork)
library(stargazer)
library(EnvStats)
library(shiny)
library(kableExtra)


mptyps <- c("CartoDB.Positron", "CartoDB.DarkMatter", "OpenStreetMap", "Esri.WorldImagery", "OpenTopoMap")

mapviewOptions(leafletHeight = 300)

prj <- 4326 # wgs84

source('R/funcs.R')

data(medat)
```

## Map summary

Watersheds monitored, number of parameters measured, and number of years monitored at each station. 

```{r}
tomap <- medat %>% 
  select(StationCode, Watershed, Longitude, Latitude) %>% 
  unique %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

m1a <- mapview(tomap, zcol = 'Watershed', layer.name = 'Watershed location', homebutton = F, map.types = mptyps)

tomap <- medat %>% 
  select(StationCode, Parameter, Longitude, Latitude) %>% 
  unique %>% 
  group_by(StationCode, Longitude, Latitude) %>% 
  summarise(n = n()) %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

m2a <- mapview(tomap, zcol = 'n', layer.name = 'Number of parameters', homebutton = F, col.regions = magma, map.types = mptyps)

tomap <- medat %>% 
  select(StationCode, yr = Date, Longitude, Latitude) %>% 
  mutate(yr = year(yr)) %>% 
  unique %>% 
  group_by(StationCode, Longitude, Latitude) %>% 
  summarise(n = n()) %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

m3a <- mapview(tomap, zcol = 'n', layer.name = 'Number of years', homebutton = F, col.regions = magma, map.types = mptyps)

leafsync::sync(m1a, m2a, m3a, ncol = 1) 
```

## Nitrogen analyses, SDMF05 {.tabset .tabset-pills}

### Observed

Observed time series for major nitrogen constituents.

```{r, fig.height = 5, fig.width = 6, out.width = '80%', fig.align = 'center'}
thm <- theme_bw() + 
  theme(
    strip.background = element_blank(), 
    strip.placement = 'outside', 
    axis.title = element_blank(), 
    legend.title = element_blank(), 
    legend.position = 'bottom', 
    panel.grid = element_blank()
  )
  
nitdat <- medat %>% 
  filter(StationCode %in% 'SDMF05') %>% 
  filter(Parameter %in% c('AmmoniaN', 'NitrateNitriteNO3', 'TKN')) %>% 
  mutate(
    Parameter = case_when(
      Parameter %in% 'AmmoniaN' ~ 'Ammonia', 
      Parameter %in% 'NitrateNitriteNO3' ~ 'Nitrate, Nitrite', 
      Parameter %in% 'TKN' ~ 'Total Kjeldahl Nitrogen'
    ), 
    Detection = case_when(
      Qualifier %in% '<' ~ 'below detection', 
      T ~ 'within range'
    ),
    Year = year(Date), 
    Month = month(Date, label = T)
  )

toplo <- nitdat

p1 <- ggplot(toplo, aes(x = Date, y = Result)) + 
  geom_line() + 
  geom_point(aes(colour = Detection)) + 
  facet_wrap(~Parameter, strip.position = 'left', ncol = 1, scales = 'free_y') +
  thm + 
  # scale_y_log10() + 
  scale_colour_manual(values = c('tomato1', 'black')) + 
  labs(
    title = 'Observed nitrogen (mg/L)', 
    subtitle = 'SDMF05'
  )

p2 <- ggplot(toplo, aes(x = factor(Year), y = Result, group = Year)) + 
  geom_boxplot() + 
  facet_wrap(~Parameter, strip.position = 'left', ncol = 1, scales = 'free_y') +
  thm +
  # scale_y_log10() + 
  # scale_colour_manual(values = c('tomato1', 'black')) + 
  labs(
    title = 'Observed nitrogen (mg/L) by year', 
    subtitle = 'SDMF05'
  )

p3 <- ggplot(toplo, aes(x = Month, y = Result, group = Month)) + 
  geom_boxplot() + 
  facet_wrap(~Parameter, strip.position = 'left', ncol = 1, scales = 'free_y') +
  thm +
  # scale_y_log10() + 
  # scale_colour_manual(values = c('tomato1', 'black')) + 
  labs(
    title = 'Observed nitrogen (mg/L) by month', 
    subtitle = 'SDMF05'
  )

p1
p2 
p3
```

### Trends

```{r, fig.height = 5, fig.width = 6, out.width = '80%', fig.align = 'center'}
thm <- theme_bw() + 
  theme(
    strip.background = element_blank(), 
    strip.placement = 'outside', 
    axis.title = element_blank(), 
    legend.title = element_blank(), 
    legend.position = 'bottom', 
    panel.grid = element_blank()
  )

toplo <- nitdat %>% 
  group_by(Parameter, Year) %>% 
  summarise(
    confint = t.test(Result)$conf.int %>% range %>% diff,
    confint = confint / 2, 
    Result = mean(Result, na.rm = T), 
  ) %>% 
  group_by(Parameter) %>% 
  mutate(
    avg = mean(Result, na.rm = T),
    dev = Result - avg
  ) %>% 
  ungroup %>% 
  mutate(
    avg = round(avg, 2), 
    Parameter = paste0(Parameter, ' (', avg, ')')
  )

p1 <- ggplot(toplo, aes(x = Year, y = dev, fill = dev)) + 
  geom_bar(stat = 'identity', colour = 'grey') + 
  # geom_errorbar(aes(ymin = dev - confint, ymax = dev + confint), width = 0) +
  scale_fill_gradient2('Deviations from average (+/-)', low = 'tomato1', mid = 'grey90', high = 'lightgreen', midpoint = 0) +
  facet_wrap(~Parameter, strip.position = 'left', ncol = 1, scales = 'free_y') +
  thm +
  geom_smooth(method = 'lm', se = F, linetype = 'dashed', color = 'black') + 
  # scale_y_log10() + 
  # scale_y_continuous('Density (fish/100ft)') +
  geom_hline(aes(yintercept = 0)) + 
  labs(
    title = 'Deviation from annual averages by constituent (mg/L)', 
    subtitle = 'SDMF05, average in parentheses on y-axis'
  )

p1
```

This table shows the regression results from the above plot.

```{r, results='asis'}
mods <- toplo %>% 
  group_by(Parameter) %>% 
  nest %>% 
  mutate(
    mod = purrr::map(data, function(x) lm(dev ~ Year, x))
  ) %>% 
  ungroup %>% 
  mutate(
    Parameter = gsub('\\s\\(.*\\)$', '', Parameter)
  )
  
stargazer(mods$mod, type = 'html',
          covariate.labels = c('Year', 'Intercept'), 
          column.labels = mods$Parameter, 
          omit.stat = c('adj.rsq', 'ser'), 
          column.sep.width = '10pt', 
          dep.var.labels.include = F, 
          digits = 2
          ) 
```

The plots below show the observed time series (left) with measurements averaged to year/month (left) and a moving window average for a 12 month period with deviations around the average (right).  

```{r, fig.height = 6, fig.width = 7, out.width = '90%', fig.align = 'center'}
win <- 12
toplo <- nitdat %>%
  select(Date, Parameter, Result) %>%
  mutate(Date = floor_date(Date, unit = 'month')) %>% 
  group_by(Date, Parameter) %>% 
  summarise(Result = mean(Result, na.rm = T)) %>% 
  # group_by(Parameter) %>% 
  arrange(Parameter, Date) %>% 
  group_by(Parameter) %>% 
  mutate(
    avg = stats::filter(Result, rep(1, win)/win, sides = 1, method = 'convolution')
  ) %>% 
  ungroup %>% 
  mutate(
    dev = Result - avg
  )

p1 <- ggplot(toplo, aes(x = Date, y = Result)) + 
  geom_line() + 
  facet_wrap(~Parameter, strip.position = 'left', ncol = 1, scales = 'free_y') +
  thm + 
  # scale_y_log10() + 
  labs(
    title = 'Observed nitrogen (mg/L)', 
    subtitle = 'SDMF05'
  )

p2 <- ggplot(toplo, aes(x = Date, y = avg)) + 
  geom_segment(aes(x = Date, xend = Date, yend = avg, y = avg + dev, colour = dev), size = 0.8) + 
  geom_line(colour = 'black') + 
  facet_wrap(~Parameter, strip.position = 'left', ncol = 1, scales = 'free_y') +
  thm + 
  # scale_y_log10() + 
  scale_colour_gradient2('Devation from average (+/-)', low = 'tomato1', mid = 'grey90', high = 'lightgreen', midpoint = 0) +
  labs(
    title = 'Deviations from annual average', 
    subtitle = 'SDMF05', 
    y = NULL
  )

p1 + p2 + plot_layout(ncol = 2)
```

Kendall tests also provide an indication of a trend by evaluating magnitude, direction, and significance of a change in density between the selected years. The test is a non-parametric equivalent to the regression analysis above. The value for tau ranges from -1 to 1 and provides a measure of trend direction. The slope is the estimated change per year in density and the p-value shows the significance of the test.

```{r}
totabs1kn <- nitdat %>% 
  group_by(Parameter, Year) %>% 
  summarise(
    Result = mean(Result, na.rm = T), 
  ) %>%
  group_by(Parameter) %>% 
  mutate(
    avg = mean(Result, na.rm = T),
    dev = Result - avg
  ) %>% 
  nest %>% 
  mutate(
    res = purrr::map(data, function(x){
      
      knout <- kendallTrendTest(dev ~ Year, x)
      outest <- round(knout$estimate, 2)
      outpval <- p_ast(knout$p.value)
      out <- c(outest, pval = outpval) %>% 
        data.frame %>% 
        t %>% 
        data.frame %>% 
        select(-intercept)
      return(out)
      
    })

  ) %>% 
  select(-data) %>% 
  unnest(res)

HTML(knitr::kable(totabs1kn, format = 'html') %>% 
    kable_styling(full_width = T, font_size = 14))
```

## Nitrogen analyses, all stations {.tabset .tabset-pills}

```{r}
allnitdat <- medat %>% 
  filter(Parameter %in% c('AmmoniaN', 'NitrateNitriteNO3', 'TKN')) %>% 
  mutate(
    Parameter = case_when(
      Parameter %in% 'AmmoniaN' ~ 'Ammonia',
      Parameter %in% 'NitrateNitriteNO3' ~ 'Nitrate, Nitrite', 
      Parameter %in% 'TKN' ~ 'Total Kjeldahl Nitrogen'
    ), 
    Year = year(Date), 
    Month = month(Date, label = T)
  ) %>% 
  group_by(StationCode, Parameter, Year) %>% 
  summarise(
    Result = mean(Result, na.rm = T), 
  ) %>%
  group_by(StationCode, Parameter) %>% 
  filter(n() == 10) %>% 
  mutate(
    avg = mean(Result, na.rm = T),
    dev = Result - avg
  ) %>% 
  nest %>% 
  mutate(
    res = purrr::map(data, function(x){

      knout <- kendallTrendTest(dev ~ Year, x)
      outest <- round(knout$estimate, 2)
      outpval <- p_ast(knout$p.value)
      out <- c(outest, pval = outpval) %>% 
        data.frame %>% 
        t %>% 
        data.frame %>% 
        select(-intercept)
      return(out)
      
    })

  ) %>% 
  select(-data) %>% 
  unnest(res) %>% 
  mutate(
    tau = as.numeric(as.character(tau)), 
    slope = as.numeric(as.character(tau)),
    trend = ifelse(tau < 0, 'dec', 'inc')
  )
```

Kendall tests provide an indication of a trend by evaluating magnitude, direction, and significance of a change in density between the selected years. The test is a non-parametric equivalent to the regression analysis above. The value for tau ranges from -1 to 1 and provides a measure of trend direction. The slope is the estimated change per year in density and the p-value shows the significance of the test.

The maps show the value for tau (direction of trend) for a Kendall test of nitrogen changes for stations with ten years of data, green for decreasing and red for increasing. Size of the point is the magnitude of the estimated change between the three nitrogen constituents (ammonia left, nitrate/nitrite middle, total Kjeldahl nitrogen right).  The table shows the detailed results from the map.

```{r}
locs <- medat %>% 
  select(StationCode, Longitude, Latitude) %>% 
  unique

tomap <- allnitdat %>% 
  left_join(locs, by = 'StationCode') %>% 
  st_as_sf(coords = c("Longitude", "Latitude"), crs = prj)

 # point colors
cols <- tomap %>% 
  mutate(
    cols = factor(trend, levels = c('dec', 'inc'), labels = c('lightgreen', 'tomato1')),
    cols = as.character(cols)
  ) %>% 
  pull(cols)

# size values
cexv <- tomap %>% 
  pull(tau) %>% 
  abs %>% 
  scales::rescale(to = c(2, 15))

# hover pt labels
labs <- paste(tomap$SiteID, ': ', tomap$trend, ', tau = ', tomap$tau, ', p = ', tomap$pval)

mapviewOptions(leafletHeight = 400)

m1sel <- 'Ammonia'
m1map <- tomap %>% filter(Parameter %in% m1sel)
m1cexv <- cexv[tomap$Parameter %in% m1sel]
m1labs <- labs[tomap$Parameter %in% m1sel]
m1cols <- cols[tomap$Parameter %in% m1sel]
m1b <- mapview(m1map, zcol = 'tau', cex = m1cexv, label = m1labs, col.regions = m1cols, legend = F, layer.name = m1sel, map.types = mptyps)

m2sel <- 'Nitrate, Nitrite'
m2map <- tomap %>% filter(Parameter %in% m2sel)
m2cexv <- cexv[tomap$Parameter %in% m2sel]
m2labs <- labs[tomap$Parameter %in% m2sel]
m2cols <- cols[tomap$Parameter %in% m2sel]
m2b <- mapview(m2map, zcol = 'tau', cex = m2cexv, label = m2labs, col.regions = m2cols, legend = F, layer.name = m2sel, map.types = mptyps)

m3sel <- 'Total Kjeldahl Nitrogen'
m3map <- tomap %>% filter(Parameter %in% m3sel)
m3cexv <- cexv[tomap$Parameter %in% m3sel]
m3labs <- labs[tomap$Parameter %in% m3sel]
m3cols <- cols[tomap$Parameter %in% m3sel]
m3b <- mapview(m3map, zcol = 'tau', cex = m3cexv, label = m3labs, col.regions = m3cols, legend = F, layer.name = m3sel, map.types = mptyps)

leafsync::sync(m1b, m2b, m3b, ncol = 3) 
```

```{r}
totab <- allnitdat %>% 
  ungroup %>% 
  arrange(Parameter, StationCode) %>% 
  mutate(
    Parameter = ifelse(duplicated(Parameter), '', Parameter)
  ) %>% 
  select(Parameter, StationCode, everything())

HTML(knitr::kable(totab, format = 'html') %>% 
    kable_styling(full_width = T, font_size = 14))
```