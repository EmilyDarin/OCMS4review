---
output: 
  html_document:
      css: styles.css
runtime: shiny
---
  
# Evaluation of OC MS4 monitoring program, dry weather monitoring {.tabset}
  
```{r setup, message = F, warning = F, results = 'hide', echo = F}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, echo = F, fig.path = 'figs/', dev.args = list(family = 'serif'))

library(tidyverse)
library(sf)
library(mapview)
library(lubridate)
library(leafsync)
library(viridisLite)
library(lubridate)
library(gridExtra)
library(stargazer)
library(EnvStats)
library(shiny)
library(kableExtra)
library(mgcv)
library(metR)
library(shinyWidgets)
library(plotly)
library(english)

mptyps <- c("CartoDB.Positron", "CartoDB.DarkMatter", "OpenStreetMap", "Esri.WorldImagery", "OpenTopoMap")

mapviewOptions(leafletHeight = 300)

prj <- 4326 # wgs84

source('R/funcs.R')

thm1 <- theme_bw(base_size = 12) + 
  theme(
    strip.background = element_blank(), 
    strip.placement = 'outside', 
    axis.title.x = element_blank(), 
    legend.title = element_blank(), 
    legend.position = 'bottom', 
    panel.grid = element_blank()
  )

thm2 <- theme_bw(base_size = 16) + 
  theme(
    strip.background = element_blank(), 
    strip.placement = 'outside', 
    legend.position = 'bottom', 
    panel.grid = element_blank()
  )

data(dwdat)

# rename some nutrient parameters
dwdat <- dwdat %>% 
  mutate(
    Parameter = case_when(
      Parameter %in% c('AmmoniaN', 'AmmoniaAsN') ~ 'Ammonia', 
      Parameter %in% 'NitrateNitriteNO3' ~ 'Nitrate, Nitrite', 
      Parameter %in% 'TKN' ~ 'Total Kjeldahl Nitrogen',
      Parameter %in% 'NitrateAsN' ~ 'Total Nitrogen',
      Parameter %in% 'OrthoPhosphateP' ~ 'Orthophosphate', 
      Parameter %in% 'TotalPhosphorusPO4' ~ 'Total Phosphorus', 
      T ~ Parameter
    )
  ) 

# nutrientd and top ten parameters
nuts <- c('Ammonia', 'Nitrate, Nitrite', 'Total Kjeldahl Nitrogen', 'Total Nitrogen', 'Orthophosphate', 'Total Phosphorus')
tops <- table(dwdat$Parameter) %>% sort %>% rev %>% .[1:10] %>% names %>% sort
```

```{r reactives}
wshpardat <- reactive({

  # inputs
  wshsel <- input$wshsel
  varsel <- input$varsel

  out <- dwdat %>%
    filter(Watershed %in% wshsel) %>%
    mutate(
      Year = year(Date),
      Month = month(Date, label = T)
    ) %>%
    filter(Parameter %in% varsel)

  return(out)

})

# further subset of wshpardat by stations
stawshpardat <- reactive({
  
  # inputs
  wshpardat <- wshpardat()
  stasel <- input$stasel

  out <- wshpardat %>% 
    filter(StationCode %in% stasel)
  
  return(out)
  
})

# stawshspardat with threshold
thrstawshpardat <- reactive({
  
  req(nrow(stawshpardat()) > 0)
  req(!is.null(input$thrsel))
  
  # inputs
  stawshpardat <- stawshpardat()
  thrsel <- as.numeric(input$thrsel)

  out <- stawshpardat %>% 
    mutate(
      abvthr = case_when(
        Result >= thrsel ~ 'Above threshold', 
        Result < thrsel ~ 'Below threshold'
      ), 
      abvthr = factor(abvthr, levels = c('Above threshold', 'Below threshold'))
    )
  
  return(out)
  
})

# text summary of thresholds analyses
thrtx <- reactive({
  
  req(nrow(thrstawshpardat()) > 0)
  
  # input
  thrstawshpardat <- thrstawshpardat()
  thrsel <- as.numeric(input$thrsel)
  
  # n stations exceeding
  nsta <- thrstawshpardat %>% 
    group_by(StationCode) %>% 
    summarise(abv = any(abvthr == 'Above threshold')) %>% 
    pull(abv) %>% 
    sum
  
  # total stations
  totsta <- thrstawshpardat %>% 
    pull(StationCode) %>% 
    unique %>% 
    length
  
  # percent stations exceeding
  persta <- round(100 * nsta / totsta, 1)
  
  # nobs exceeding
  nobs<- thrstawshpardat %>% 
    mutate(abv = abvthr == 'Above threshold') %>% 
    pull(abv) %>% 
    sum
  
  # total obs
  totobs <- nrow(thrstawshpardat)
  
  # percent observations exceeding
  perobs <- round(100 * nobs / totobs, 1)
  
  out <- paste0('For the threshold ', thrsel, ': ', english(nsta), ' of ', english(totsta), ' stations (', persta, '%) exceeding, ', nobs, ' observations of ', totobs, ' exceeding (', perobs, '%).')
  
  return(out)
  
})

# first observed plot
obsp1 <- reactive({

  req(nrow(thrstawshpardat()) > 0)
  
  # inputs
  thrstawshpardat <- thrstawshpardat()
  wshsel <- input$wshsel
  logsel <- input$logsel
  thrsel <- as.numeric(input$thrsel)

  toplo <- thrstawshpardat
  
  # labels
  ylb <- paste0('Concentration (', unique(toplo$Units), ')')
  ttl <- unique(toplo$Parameter)

  p <- ggplot(toplo, aes(x = Date, y = Result, group = StationCode)) +
    geom_hline(yintercept = thrsel, linetype = 'dotted', colour = 'tomato1') +
    geom_line() +
    geom_point(aes(colour = abvthr), alpha = 0.6) +
    scale_colour_manual(values = c('tomato1', 'black'), drop = F) +
    thm1 +
    labs(
      subtitle = wshsel,
      title = ttl,
      y = ylb
    )
  
  if(logsel)
    p <- p + 
      scale_y_log10()

  p <- ggplotly(p)
  
  return(p)

})

# second observed plot
obsp2 <- reactive({

  req(nrow(thrstawshpardat()) > 0)
  
  # inputs
  thrstawshpardat <- thrstawshpardat()
  wshsel <- input$wshsel
  logsel <- input$logsel
  thrsel <- as.numeric(input$thrsel)

  toplo <- thrstawshpardat
  
  # labels
  ttl <- paste(unique(toplo$Parameter), 'by year')
  ylb <- paste0('Concentration (', unique(toplo$Units), ')')

  p <- ggplot(toplo, aes(x = factor(Year), y = Result, group = Year, label = StationCode)) +
    geom_hline(yintercept = thrsel, linetype = 'dotted', colour = 'tomato1') +
    geom_boxplot(outlier.shape = NA) +
    geom_point(aes(colour = abvthr), position = position_jitter(width = 0.2), alpha = 0.6) +
    scale_colour_manual(values = c('tomato1', 'black'), drop = F) +
    thm1 +
    labs(
      subtitle = wshsel,
      title = ttl,
      y = ylb
    )
  
  if(logsel)
    p <- p + 
      scale_y_log10()

  p <- ggplotly(p)
  
  return(p)

})

# third observed plot
obsp3 <- reactive({

  req(nrow(thrstawshpardat()) > 0)
  
  # inputs
  thrstawshpardat <- thrstawshpardat()
  wshsel <- input$wshsel
  logsel <- input$logsel
  thrsel <- as.numeric(input$thrsel)
  
  toplo <- thrstawshpardat
  
  # labels
  ttl <- paste(unique(toplo$Parameter), 'by month')
  ylb <- paste0('Concentration (', unique(toplo$Units), ')')
  
  p <- ggplot(toplo, aes(x = Month, y = Result, group = Month, label = StationCode)) +
    geom_hline(yintercept = thrsel, linetype = 'dotted', colour = 'tomato1') +
    geom_boxplot(outlier.shape = NA) +
    geom_point(aes(colour = abvthr), position = position_jitter(width = 0.2), alpha = 0.6) +
    scale_colour_manual(values = c('tomato1', 'black'), drop = F) +
    thm1 +
    labs(
      subtitle = wshsel,
      title = ttl,
      y = ylb
    )

  if(logsel)
    p <- p + 
      scale_y_log10()
  
  return(p)

})
```

## Inventory {.tabset .tabset-pills}

### Maps

Watersheds monitored, number of parameters measured, and number of years monitored at each station. 

```{r}
tomap <- dwdat %>% 
  select(StationCode, Watershed, Longitude, Latitude) %>% 
  unique %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

m1a <- mapview(tomap, zcol = 'Watershed', layer.name = 'Watershed location', homebutton = F, map.types = mptyps)

tomap <- dwdat %>% 
  select(StationCode, Parameter, Longitude, Latitude) %>% 
  unique %>% 
  group_by(StationCode, Longitude, Latitude) %>% 
  summarise(n = n()) %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

m2a <- mapview(tomap, zcol = 'n', layer.name = 'Number of parameters', homebutton = F, col.regions = magma, map.types = mptyps)

tomap <- dwdat %>% 
  select(StationCode, yr = Date, Longitude, Latitude) %>% 
  mutate(yr = year(yr)) %>% 
  unique %>% 
  group_by(StationCode, Longitude, Latitude) %>% 
  summarise(n = n()) %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

m3a <- mapview(tomap, zcol = 'n', layer.name = 'Number of years', homebutton = F, col.regions = magma, map.types = mptyps)

leafsync::sync(m1a, m2a, m3a, ncol = 1) 
```

### Tables

```{r toptab}
sums <- dwdat %>% 
  filter(Parameter %in% tops) %>% 
  count(Parameter, Watershed) %>% 
  bind_rows(group_by(., Parameter) %>%
              summarise(n=sum(n)) %>%
              mutate(Watershed='Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Parameter='Total')) %>%
  spread(Parameter,n,fill=0) %>% 
  select_at(c('Watershed', tops, 'Total'))

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Top ten parameters") %>% 
       kable_styling(full_width = T, font_size = 14))
```

```{r toptabyr}
sums <- dwdat %>% 
  mutate(Year = as.character(year(Date))) %>% 
  filter(Parameter %in% tops) %>% 
  count(Year, Watershed) %>% 
  bind_rows(group_by(., Year) %>%
              summarise(n = sum(n)) %>%
              mutate(Watershed = 'Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Year = 'Total')) %>%
  spread(Year,n,fill=0)

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Top ten parameters by year") %>% 
       kable_styling(full_width = T, font_size = 14))
```

```{r toptabmo}
sums <- dwdat %>% 
  mutate(Month = month(Date, label = TRUE)) %>% 
  filter(Parameter %in% tops) %>% 
  count(Month, Watershed) %>% 
  bind_rows(group_by(., Month) %>%
              summarise(n = sum(n)) %>%
              mutate(Watershed = 'Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Month = 'Total')) %>%
  mutate(Month = factor(Month, levels = c("May", "Jun", "Jul", "Aug", "Sep", "Total"))) %>%
  spread(Month,n,fill=0)

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Top ten parameters by month") %>% 
       kable_styling(full_width = T, font_size = 14))
```

```{r nuttab}
sums <- dwdat %>% 
  filter(Parameter %in% nuts) %>% 
  count(Parameter, Watershed) %>% 
  bind_rows(group_by(., Parameter) %>%
              summarise(n=sum(n)) %>%
              mutate(Watershed='Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Parameter='Total')) %>%
  spread(Parameter,n,fill=0) %>% 
  select_at(c('Watershed', nuts, 'Total'))

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Nutrients") %>% 
       kable_styling(full_width = T, font_size = 14))
```

```{r nuttabyr}
sums <- dwdat %>% 
  mutate(Year = as.character(year(Date))) %>% 
  filter(Parameter %in% nuts) %>% 
  count(Year, Watershed) %>% 
  bind_rows(group_by(., Year) %>%
              summarise(n = sum(n)) %>%
              mutate(Watershed = 'Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Year = 'Total')) %>%
  spread(Year,n,fill=0)

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Nutrients by year") %>% 
       kable_styling(full_width = T, font_size = 14))
```

```{r nuttabmo}
sums <- dwdat %>% 
  mutate(Month = month(Date, label = T)) %>% 
  filter(Parameter %in% nuts) %>% 
  count(Month, Watershed) %>% 
  bind_rows(group_by(., Month) %>%
              summarise(n = sum(n)) %>%
              mutate(Watershed = 'Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Month = 'Total')) %>%
  mutate(Month = factor(Month, levels = c("May", "Jun", "Jul", "Aug", "Sep", "Total"))) %>% 
  spread(Month,n,fill=0)

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Nutrients by month") %>% 
       kable_styling(full_width = T, font_size = 14))
```

## Analyses by watershed {.tabset .tabset-pills}

```{r}
column(12, 
       column(4, 
              selectInput('wshsel', 'Select watershed:', choices = unique(dwdat$Watershed))
       ),
       column(4,
               selectInput('varsel', 'Select constituent:', choices = c(tops, nuts), selected = 'ENT')
       ), 
       column(4, 
              renderUI({
      
                # input
                spaflt <- wshpardat()
                stas <- unique(wshpardat()$StationCode)
                
                pickerInput(inputId = "stasel", label = 'Select stations:', choices = stas,
                  options = list(`actions-box` = TRUE, size = 20), selected = stas, multiple = TRUE)      
                
              })
        )
)
column(12, 
       column(4, 
              selectInput('logsel', 'Log scale?', choices = c(F, T))
       ), 
       column(4, 
              renderUI({
                
                req(nrow(stawshpardat())> 0)
                
                # inputs
                stawshpardat <- stawshpardat()
            
                # get range, ave for selector
                qnts <- seq(0, 1, by = 0.1)
                qntval <- stawshpardat %>%
                  pull(Result) %>% 
                  quantile(probs = qnts, na.rm = T) %>%
                  round(2) %>% 
                  as.list()
                
                selectInput('thrsel', 'Select threshold as quantile:', choices = qntval, selected = qntval[10])
                # sliderInput('thrsel', 'Select threshold:', min = rngval[1], max = rngval[2], value = qntval, width = '600px')

                
              })
        )
)
```

### Observed

`r renderText({thrtx()})`

```{r}
output$obsp1 <- renderPlotly({obsp1()})
output$obsp2 <- renderPlotly({obsp2()})
output$obsp3 <- renderPlotly({obsp3()})
plotlyOutput('obsp1', height = "400px", width = "900px")
plotlyOutput('obsp2', height = "400px", width = "900px")
plotlyOutput('obsp3', height = "400px", width = "900px")
```
