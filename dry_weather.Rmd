---
output: 
  html_document:
      css: styles.css
runtime: shiny
---
  
# Evaluation of OC MS4 monitoring program, dry weather monitoring {.tabset}
  
```{r setup, message = F, warning = F, results = 'hide', echo = F}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, echo = F, fig.path = 'figs/', dev.args = list(family = 'serif'))

library(tidyverse)
library(sf)
library(mapview)
library(leaflet)
library(lubridate)
library(leafsync)
library(viridisLite)
library(lubridate)
library(gridExtra)
library(stargazer)
library(EnvStats)
library(shiny)
library(kableExtra)
library(mgcv)
library(metR)
library(shinyWidgets)
library(plotly)
library(english)
library(vegan)
library(ggord)
library(patchwork)

mptyps <- c("CartoDB.Positron", "CartoDB.DarkMatter", "OpenStreetMap", "Esri.WorldImagery", "OpenTopoMap")

mapviewOptions(leafletHeight = 300)

prj <- 4326 # wgs84

source('R/funcs.R')

##
# ggplot themes

thm1 <- theme_bw(base_size = 12) + 
  theme(
    strip.background = element_blank(), 
    strip.placement = 'outside', 
    axis.title.x = element_blank(), 
    legend.title = element_blank(), 
    legend.position = 'bottom', 
    panel.grid = element_blank()
  )

thm2 <- theme_bw(base_size = 16) + 
  theme(
    strip.background = element_blank(), 
    strip.placement = 'outside', 
    legend.position = 'bottom', 
    panel.grid = element_blank()
  )

pbase <- theme_bw(base_family = 'serif') +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12), 
    axis.text.y = element_text(size = 12),
    legend.position = 'top',
    legend.direction = 'horizontal',
    # plot.margin = unit(c(4,4,0,0), "lines"),
    strip.background = element_blank(), 
    strip.text.y = element_text(angle = 0, hjust = 0, vjust = 0.5), 
    panel.background = element_rect(fill = 'black')
  ) 

data(dwdat)

# xy locs
locs <- dwdat %>%
  select(StationCode, Longitude, Latitude) %>%
  unique

# date ranges
dts <- dwdat %>% 
  pull(Date) %>% 
  range

# obs ranges per station
obsrng <- dwdat %>% 
  group_by(StationCode, Parameter) %>% 
  summarise(n = n()) %>% 
  pull(n) %>% 
  range

# obs ranges per station, averages across parameters
obsave <- dwdat %>% 
  group_by(StationCode, Parameter) %>% 
  summarise(n = n()) %>% 
  group_by(StationCode) %>% 
  summarise(n = mean(n, na.rm = T)) %>% 
  mutate(n = round(n, 1))
obsaverng <- obsave %>% 
  pull(n) %>% 
  range

# color palette for hotspot exceedances, as prop
hotcol <- colorNumeric(
  palette = rev(RColorBrewer::brewer.pal(11, 'RdYlBu')),
  na.color = 'yellow',
    domain = c(0, 100)
  )

# nutrients and top ten parameters
nutrs <- c('Ammonia', 'Nitrate, Nitrite', 'Total Kjeldahl Nitrogen', 'Total Nitrogen', 'Orthophosphate', 'Total Phosphorus')
tops <- table(dwdat$Parameter) %>% sort %>% rev %>% .[1:10] %>% names %>% sort
```

```{r reactives}
# tabular inventory by station, parameter
statab <- reactive({
  
  # input
  wshsel2 <- input$wshsel2
  varsel2 <- input$varsel2
  tabsel <- input$tabsel
  
  dat <- dwdat %>% 
    filter(Watershed %in% wshsel2) %>% 
    filter(Parameter %in% varsel2)
  
  if(tabsel == 'by year'){
    
    sums <- dat %>% 
      mutate(Year = as.character(year(Date))) %>% 
      count(Year, StationCode) %>% 
      bind_rows(group_by(., Year) %>%
                  summarise(n = sum(n)) %>%
                  mutate(StationCode = 'Total')) %>%
      bind_rows(group_by(., StationCode) %>%
                  summarise(n=sum(n)) %>%
                  mutate(Year = 'Total')) %>%
      spread(Year, n, fill = 0)

  }

  if(tabsel == 'by month'){
    
    sums <- dat %>% 
      mutate(Month = month(Date, label = TRUE)) %>% 
      count(Month, StationCode) %>% 
      bind_rows(group_by(., Month) %>%
                  summarise(n = sum(n)) %>%
                  mutate(StationCode = 'Total')) %>%
      bind_rows(group_by(., StationCode) %>%
                  summarise(n=sum(n)) %>%
                  mutate(Month = 'Total')) %>%
      mutate(Month = factor(Month, levels = c("May", "Jun", "Jul", "Aug", "Sep", "Total"))) %>%
      spread(Month,n,fill=0)
    
  }
  
  alltot <- sums %>% 
    filter(StationCode != 'Total')
  coltot <- sums %>% 
    filter(StationCode == 'Total')

  totab <- bind_rows(alltot, coltot)

  tab <- HTML(knitr::kable(totab, format = 'html', caption = paste(varsel2, tabsel)) %>% 
       kable_styling(full_width = T, font_size = 14))
    
  
  return(tab)
  
})

# plot inventory by station, parameter
staplo <- reactive({
  
  # input
  wshsel2 <- input$wshsel2
  varsel2 <- input$varsel2
  tabsel <- input$tabsel
  
  dat <- dwdat %>% 
    filter(Watershed %in% wshsel2)

  if(tabsel == 'by year'){
    
    colrng = c(0, 7)
    
    sums <- dat %>% 
      mutate(Year = as.character(year(Date))) %>% 
      count(Year, StationCode, Parameter) %>% 
      mutate(Year = factor(Year, levels = c(2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019))) %>% 
      complete(Year, StationCode, Parameter, fill = list(n = 0)) %>% 
      filter(Parameter %in% varsel2) %>% 
      rename(x = Year)

  }

  if(tabsel == 'by month'){
    
    colrng <- c(0, 12)
    
    sums <- dat %>% 
      mutate(Month = month(Date, label = TRUE)) %>% 
      count(Month, StationCode, Parameter) %>% 
      mutate(Month = factor(Month, levels = c("May", "Jun", "Jul", "Aug", "Sep"))) %>% 
      tidyr::complete(Month, StationCode, Parameter, fill = list(n = 0)) %>% 
      filter(Parameter %in% varsel2) %>% 
      rename(x = Month)
    
  }
  
  toplo <- sums %>% 
    mutate(StationCode = factor(StationCode, levels = rev(unique(StationCode))))
  txtplo <- toplo %>% 
    filter(n > 0)

  p <- ggplot(toplo) +
    geom_tile(aes(x = x, y = StationCode, fill = n), colour = 'black') +
    geom_text(data = txtplo, aes(x = x, y = StationCode, label = n)) + 
    scale_x_discrete('', expand = c(0, 0)) +
    scale_y_discrete('', expand = c(0, 0)) +
    scale_fill_gradientn('Number of samples', colors = RColorBrewer::brewer.pal(9, 'BuGn'), limits = colrng) +
    guides(fill = guide_colourbar(barheight = 0.5, barwidth = 10, label.theme = element_text(size = 11, angle = 0))) +
    pbase
  
  return(p)
  
})

# hotspot input ranges
hotrng <- reactive({
  
  # inputs
  varsel3 <- input$varsel3
  
  # values for slider
  qnts <- c(0, 0.5, 1)
  out <- dwdat %>% 
    filter(Parameter %in% varsel3) %>%
    pull(Result) %>% 
    quantile(probs = qnts, na.rm = T) %>%
    round(2)
  
  return(out)
  
})

# hotspot data
hotdat <- reactive({
  
  # inputs
  cntsel <- input$cntsel
  varsel3 <- input$varsel3
  dtssel <- input$dtssel
  thrsel2 <- input$thrsel2
  
  req(thrsel2)

  # summary for all dates, stations by selected constituent
  out <- dwdat %>% 
    filter(Parameter %in% varsel3) %>%
    group_by(Watershed, StationCode) %>% 
    mutate(n = n()) %>% 
    filter(Date >= dtssel[1] & Date <= dtssel[2]) %>%
    mutate(
      abv = case_when(
        Result > thrsel2 ~ 1, 
        T ~ 0
      )
    ) %>% 
    summarise(
      exceeds = sum(abv),
      n = unique(n)
      ) %>% 
    ungroup() %>% 
    mutate(
      exceeds = round(100 * exceeds / n, 0), 
      cols = hotcol(exceeds), 
      cexs = scales::rescale(exceeds, to = c(4, 17), from = c(0, 100))
    ) %>% 
    select(Watershed, StationCode, exceeds, n, cols, cexs) %>% 
    filter(n >= cntsel[1] & n <= cntsel[2]) %>% 
    unique
  
  return(out)
  
})

# map of exceedances
hotmap <- reactive({
  
  # input
  hotdat <- hotdat()
  
  tomap <- hotdat %>%
    left_join(locs, by = 'StationCode') %>%
    st_as_sf(coords = c("Longitude", "Latitude"), crs = prj)

  # hover pt labels
  labs <- paste(tomap$StationCode, ': ', tomap$exceeds, ' % exceeding, ', tomap$n, ' total obs.')
  leglab <- "% exceeding"
  
  mapviewOptions(leafletHeight = 400)

  m <- mapview(tomap, zcol = 'n', cex = tomap$cexs, label = labs, legend = F, layer.name = F, col.regions = tomap$cols, homebutton = F, map.types = mptyps)
  
  # add legend
  out <- m@map %>% 
    addLegend("bottomright", pal = hotcol, title = leglab, opacity = 1, values = tomap$exceeds) 
  
  return(out)
  
})

# plot of hotspots by watershed
hotplo <- reactive({
  
  # input
  hotdat <- hotdat()
  dtssel <- input$dtssel
  
  toplo <- hotdat %>% 
    arrange(Watershed, exceeds) %>% 
    mutate(StationCode = factor(StationCode, levels = .$StationCode))

  ylab <- paste0("Number of exceedances above the median\nfrom ", as.character(dtssel[1]), ' to ', as.character(dtssel[2]))
  
  p <- ggplot(toplo, aes(x = StationCode, y = exceeds)) + 
    geom_bar(stat = 'identity', fill = toplo$cols, color = 'grey') + 
    facet_grid(~ Watershed, scales = 'free_x', space = 'free_x') + 
    thm1 + 
    theme(
      axis.text.x = element_text(size = 7, angle = 45, hjust = 1)
    ) + 
    scale_y_continuous(limits = c(0, 100)) + 
    labs(
      y = ylab
    )

  return(p)
  
})

# quantiles based on thrsel3
hotrng2 <- reactive({
  
  # input
  thrsel3 <- input$thrsel3
  
  out <- dwdat %>% 
    filter(Parameter %in% tops) %>%
    group_by(Parameter) %>% 
    summarise(
      qnt = quantile(Result, probs = as.numeric(thrsel3), na.rm= T)
    )
  
  return(out)
  
})

# hotspot data
hotdat2 <- reactive({
  
  # inputs
  cntsel2 <- input$cntsel2
  dtssel2 <- input$dtssel2
  hotrng2 <- hotrng2()
  
  req(hotrng2)
  
  # summary for all dates, stations by selected constituent
  out <- dwdat %>% 
    filter(Parameter %in% tops) %>%
    left_join(hotrng2, by = 'Parameter') %>% 
    left_join(obsave, by = 'StationCode') %>% 
    filter(n >= cntsel2[1] & n <= cntsel2[2]) %>% 
    filter(Date >= dtssel2[1] & Date <= dtssel2[2]) %>%
    mutate(
      abv = case_when(
        Result > qnt ~ 1, 
        T ~ 0
      )
    ) %>% 
    group_by(StationCode, Watershed, Parameter, n) %>% 
    summarise(
      exceeds = sum(abv, na.rm = T)
      ) %>% 
    group_by(StationCode, Watershed, n) %>% 
    summarise(
      exceeds = mean(exceeds, na.rm = T)
    ) %>% 
    ungroup() %>% 
    mutate(
      exceeds = round(100 * exceeds / n, 0), 
      cols = hotcol(exceeds), 
      cexs = scales::rescale(exceeds, to = c(4, 17), from = c(0, 100))
    ) %>% 
    select(Watershed, StationCode, exceeds, n, cols, cexs) %>% 
    unique
  
  return(out)
  
})

# map of exceedances
hotmap2 <- reactive({
  
  # input
  hotdat2 <- hotdat2()
  
  tomap <- hotdat2 %>%
    left_join(locs, by = 'StationCode') %>%
    st_as_sf(coords = c("Longitude", "Latitude"), crs = prj)

  # hover pt labels
  labs <- paste(tomap$StationCode, ': ', tomap$exceeds, ' avg % exceedences, ', tomap$n, ' total avg obs.')
  leglab <- "% exceedances"
  
  mapviewOptions(leafletHeight = 400)

  m <- mapview(tomap, zcol = 'n', cex = tomap$cexs, label = labs, legend = F, layer.name = F, col.regions = tomap$cols, homebutton = F, map.types = mptyps)
  
  # add legend
  out <- m@map %>% 
    addLegend("bottomright", pal = hotcol, title = leglab, opacity = 1, values = tomap$exceeds) 
  
  return(out)
  
})

# plot of hotspots by watershed
hotplo2 <- reactive({
  
  # input
  hotdat2 <- hotdat2()
  dtssel <- input$dtssel
  
  toplo <- hotdat2 %>% 
    arrange(Watershed, exceeds) %>% 
    mutate(StationCode = factor(StationCode, levels = .$StationCode))

  ylab <- paste0("Number of exceedances above the median\nfrom ", as.character(dtssel[1]), ' to ', as.character(dtssel[2]))
  
  p <- ggplot(toplo, aes(x = StationCode, y = exceeds)) + 
    geom_bar(stat = 'identity', fill = toplo$cols, color = 'grey') + 
    facet_grid(~ Watershed, scales = 'free_x', space = 'free_x') + 
    thm1 + 
    theme(
      axis.text.x = element_text(size = 7, angle = 45, hjust = 1)
    ) + 
    scale_y_continuous(limits = c(0, 100)) + 
    labs(
      y = ylab
    )

  return(p)
  
})

# watershed and parameter data for observed plots
wshpardat <- reactive({

  # inputs
  wshsel <- input$wshsel
  varsel <- input$varsel

  out <- dwdat %>%
    filter(Watershed %in% wshsel) %>%
    mutate(
      Year = year(Date),
      Month = month(Date, label = T)
    ) %>%
    filter(Parameter %in% varsel)

  return(out)

})

# further subset of wshpardat by stations
stawshpardat <- reactive({
  
  # inputs
  wshpardat <- wshpardat()
  stasel <- input$stasel

  out <- wshpardat %>% 
    filter(StationCode %in% stasel)
  
  return(out)
  
})

# stawshspardat with threshold
thrstawshpardat <- reactive({
  
  req(nrow(stawshpardat()) > 0)
  req(!is.null(input$thrsel))
  
  # inputs
  stawshpardat <- stawshpardat()
  thrsel <- as.numeric(input$thrsel)

  out <- stawshpardat %>% 
    mutate(
      abvthr = case_when(
        Result >= thrsel ~ 'Above threshold', 
        Result < thrsel ~ 'Below threshold'
      ), 
      abvthr = factor(abvthr, levels = c('Above threshold', 'Below threshold'))
    )
  
  return(out)
  
})

# text summary of thresholds analyses
thrtx <- reactive({
  
  req(nrow(thrstawshpardat()) > 0)
  
  # input
  thrstawshpardat <- thrstawshpardat()
  thrsel <- as.numeric(input$thrsel)
  
  # n stations exceeding
  nsta <- thrstawshpardat %>% 
    group_by(StationCode) %>% 
    summarise(abv = any(abvthr == 'Above threshold')) %>% 
    pull(abv) %>% 
    sum
  
  # total stations
  totsta <- thrstawshpardat %>% 
    pull(StationCode) %>% 
    unique %>% 
    length
  
  # percent stations exceeding
  persta <- round(100 * nsta / totsta, 1)
  
  # nobs exceeding
  nobs<- thrstawshpardat %>% 
    mutate(abv = abvthr == 'Above threshold') %>% 
    pull(abv) %>% 
    sum
  
  # total obs
  totobs <- nrow(thrstawshpardat)
  
  # percent observations exceeding
  perobs <- round(100 * nobs / totobs, 1)
  
  out <- paste0('For the threshold ', thrsel, ': ', english(nsta), ' of ', english(totsta), ' stations (', persta, '%) exceeding, ', nobs, ' observations of ', totobs, ' exceeding (', perobs, '%).')
  
  return(out)
  
})

# first observed plot
obsp1 <- reactive({

  req(nrow(thrstawshpardat()) > 0)
  
  # inputs
  thrstawshpardat <- thrstawshpardat()
  wshsel <- input$wshsel
  logsel <- input$logsel
  thrsel <- as.numeric(input$thrsel)

  toplo <- thrstawshpardat
  
  # labels
  ylb <- paste0('Concentration (', unique(toplo$Units), ')')
  ttl <- unique(toplo$Parameter)

  p <- ggplot(toplo, aes(x = Date, y = Result, group = StationCode)) +
    geom_hline(yintercept = thrsel, linetype = 'dotted', colour = 'tomato1') +
    geom_line() +
    geom_point(aes(colour = abvthr), alpha = 0.6) +
    scale_colour_manual(values = c('tomato1', 'black'), drop = F) +
    thm1 +
    labs(
      subtitle = wshsel,
      title = ttl,
      y = ylb
    )
  
  if(logsel)
    p <- p + 
      scale_y_log10()

  p <- ggplotly(p)
  
  return(p)

})

# second observed plot
obsp2 <- reactive({

  req(nrow(thrstawshpardat()) > 0)
  
  # inputs
  thrstawshpardat <- thrstawshpardat()
  wshsel <- input$wshsel
  logsel <- input$logsel
  thrsel <- as.numeric(input$thrsel)

  toplo <- thrstawshpardat
  
  # labels
  ttl <- paste(unique(toplo$Parameter), 'by year')
  ylb <- paste0('Concentration (', unique(toplo$Units), ')')

  p <- ggplot(toplo, aes(x = factor(Year), y = Result, group = Year, label = StationCode)) +
    geom_hline(yintercept = thrsel, linetype = 'dotted', colour = 'tomato1') +
    geom_boxplot(outlier.shape = NA) +
    geom_point(aes(colour = abvthr), position = position_jitter(width = 0.2), alpha = 0.6) +
    scale_colour_manual(values = c('tomato1', 'black'), drop = F) +
    thm1 +
    labs(
      subtitle = wshsel,
      title = ttl,
      y = ylb
    )
  
  if(logsel)
    p <- p + 
      scale_y_log10()

  p <- ggplotly(p)
  
  return(p)

})

# third observed plot
obsp3 <- reactive({

  req(nrow(thrstawshpardat()) > 0)
  
  # inputs
  thrstawshpardat <- thrstawshpardat()
  wshsel <- input$wshsel
  logsel <- input$logsel
  thrsel <- as.numeric(input$thrsel)
  
  toplo <- thrstawshpardat
  
  # labels
  ttl <- paste(unique(toplo$Parameter), 'by month')
  ylb <- paste0('Concentration (', unique(toplo$Units), ')')
  
  p <- ggplot(toplo, aes(x = Month, y = Result, group = Month, label = StationCode)) +
    geom_hline(yintercept = thrsel, linetype = 'dotted', colour = 'tomato1') +
    geom_boxplot(outlier.shape = NA) +
    geom_point(aes(colour = abvthr), position = position_jitter(width = 0.2), alpha = 0.6) +
    scale_colour_manual(values = c('tomato1', 'black'), drop = F) +
    thm1 +
    labs(
      subtitle = wshsel,
      title = ttl,
      y = ylb
    )

  if(logsel)
    p <- p + 
      scale_y_log10()
  
  return(p)

})
```

## Inventory {.tabset .tabset-pills}

### Maps

Watersheds monitored, number of parameters measured, and number of years monitored at each station. 

```{r}
tomap <- dwdat %>% 
  select(StationCode, Watershed, Longitude, Latitude) %>% 
  unique %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

m1a <- mapview(tomap, zcol = 'Watershed', layer.name = 'Watershed location', homebutton = F, map.types = mptyps)

tomap <- dwdat %>% 
  select(StationCode, Parameter, Longitude, Latitude) %>% 
  unique %>% 
  group_by(StationCode, Longitude, Latitude) %>% 
  summarise(n = n()) %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

m2a <- mapview(tomap, zcol = 'n', layer.name = 'Number of parameters', homebutton = F, col.regions = magma, map.types = mptyps)

tomap <- dwdat %>% 
  select(StationCode, yr = Date, Longitude, Latitude) %>% 
  mutate(yr = year(yr)) %>% 
  unique %>% 
  group_by(StationCode, Longitude, Latitude) %>% 
  summarise(n = n()) %>% 
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = prj)

m3a <- mapview(tomap, zcol = 'n', layer.name = 'Number of years', homebutton = F, col.regions = magma, map.types = mptyps)

leafsync::sync(m1a, m2a, m3a, ncol = 1) 
```

### Tables, by watershed

```{r toptab}
sums <- dwdat %>% 
  filter(Parameter %in% tops) %>% 
  count(Parameter, Watershed) %>% 
  bind_rows(group_by(., Parameter) %>%
              summarise(n=sum(n)) %>%
              mutate(Watershed='Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Parameter='Total')) %>%
  spread(Parameter,n,fill=0) %>% 
  select_at(c('Watershed', tops, 'Total'))

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Top ten parameters") %>% 
       kable_styling(full_width = T, font_size = 14))
```

```{r toptabyr}
sums <- dwdat %>% 
  mutate(Year = as.character(year(Date))) %>% 
  filter(Parameter %in% tops) %>% 
  count(Year, Watershed) %>% 
  bind_rows(group_by(., Year) %>%
              summarise(n = sum(n)) %>%
              mutate(Watershed = 'Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Year = 'Total')) %>%
  spread(Year,n,fill=0)

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Top ten parameters by year") %>% 
       kable_styling(full_width = T, font_size = 14))
```

```{r toptabmo}
sums <- dwdat %>% 
  mutate(Month = month(Date, label = TRUE)) %>% 
  filter(Parameter %in% tops) %>% 
  count(Month, Watershed) %>% 
  bind_rows(group_by(., Month) %>%
              summarise(n = sum(n)) %>%
              mutate(Watershed = 'Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Month = 'Total')) %>%
  mutate(Month = factor(Month, levels = c("May", "Jun", "Jul", "Aug", "Sep", "Total"))) %>%
  spread(Month,n,fill=0)

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Top ten parameters by month") %>% 
       kable_styling(full_width = T, font_size = 14))
```

```{r nuttab}
sums <- dwdat %>% 
  filter(Parameter %in% nutrs) %>% 
  count(Parameter, Watershed) %>% 
  bind_rows(group_by(., Parameter) %>%
              summarise(n=sum(n)) %>%
              mutate(Watershed='Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Parameter='Total')) %>%
  spread(Parameter,n,fill=0) %>% 
  select_at(c('Watershed', nutrs, 'Total'))

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Nutrients") %>% 
       kable_styling(full_width = T, font_size = 14))
```

```{r nuttabyr}
sums <- dwdat %>% 
  mutate(Year = as.character(year(Date))) %>% 
  filter(Parameter %in% nutrs) %>% 
  count(Year, Watershed) %>% 
  bind_rows(group_by(., Year) %>%
              summarise(n = sum(n)) %>%
              mutate(Watershed = 'Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Year = 'Total')) %>%
  spread(Year,n,fill=0)

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Nutrients by year") %>% 
       kable_styling(full_width = T, font_size = 14))
```

```{r nuttabmo}
sums <- dwdat %>% 
  mutate(Month = month(Date, label = T)) %>% 
  filter(Parameter %in% nutrs) %>% 
  count(Month, Watershed) %>% 
  bind_rows(group_by(., Month) %>%
              summarise(n = sum(n)) %>%
              mutate(Watershed = 'Total')) %>%
  bind_rows(group_by(., Watershed) %>%
              summarise(n=sum(n)) %>%
              mutate(Month = 'Total')) %>%
  mutate(Month = factor(Month, levels = c("May", "Jun", "Jul", "Aug", "Sep", "Total"))) %>% 
  spread(Month,n,fill=0)

alltot <- sums %>% 
  filter(Watershed != 'Total')
coltot <- sums %>% 
  filter(Watershed == 'Total')

totab <- bind_rows(alltot, coltot)

HTML(knitr::kable(totab, format = 'html', caption = "Nutrients by month") %>% 
       kable_styling(full_width = T, font_size = 14))
```


### By Site

```{r}
column(12, 
       column(4, 
              selectInput('wshsel2', 'Select watershed:', choices = unique(dwdat$Watershed))
       ),
       column(4, 
              selectInput('varsel2', 'Select constituent:', choices = c(tops, nutrs), selected = 'ENT')
              ),
       column(4, 
              selectInput('tabsel', 'Select table:', choices = c('by year', 'by month'))
       )
)
```


#### {.tabset .tabset-pills}

##### Table 

```{r}
renderUI({statab()})
```

##### Plot 

```{r}
renderPlot({staplo()}, height = 500, width = 700)
```

## Hotspots {.tabset .tabset-pills}

### Individual constituents

```{r}
column(12, 
       column(4, 
              selectInput('varsel3', 'Select constituent:', choices = c(tops, nutrs), selected = 'ENT')
       ),
       column(8, 
              sliderInput('dtssel', 'Select date range:', min = dts[1], max = dts[2], value = dts, timeFormat="%Y-%m", width = '600px')
       )
)
column(12,
       column(4, NULL),
       column(8,
              sliderInput('cntsel', 'Filter stations by total n:', min = 0, max = obsrng[2], value = c(0, obsrng[2]), width = '600px')
       )
)
column(12,
       column(4, NULL),
       column(4,
              renderUI({
                
                # input
                hotrng <- hotrng()
                
                numericInput('thrsel2', 'Input threshold (default median):', min = hotrng[1], max = hotrng[3], value = hotrng[2])
                
              })
       ), 
       column(4, 
              renderText({
         
                # input
                hotrng <- hotrng()
                out <- paste0("min ", hotrng[1], ', max ', hotrng[3])
                return(out)
                       
              })
       )
)
```

Map shows number of exceedances of each station above the selected value across all dates/stations for `r renderText({input$varsel3})`
```{r}
renderLeaflet(hotmap())
```

```{r}
renderPlot(hotplo(), height = 450, width = 900)
```

### Multiple constituents

```{r}
column(12, 
       column(4, NULL),
       column(8, 
              sliderInput('dtssel2', 'Select date range:', min = dts[1], max = dts[2], value = dts, timeFormat="%Y-%m", width = '600px')
       )
)
column(12,
       column(4, NULL),
       column(8,
              sliderInput('cntsel2', 'Filter stations by average n:', min = 0, max = obsaverng[2], value = c(0, obsaverng[2]), width = '600px')
       )
)
column(12,
       column(4, NULL),
       column(4,
              selectInput('thrsel3', 'Input threshold as quantile:', choices = seq(0.1, 0.9, by = 0.1), selected = 0.5)
       )
)
```

Map shows average number of exceedances of each station above the selected quantile value across all dates/stations for the top ten monitored constituents.
```{r}
renderLeaflet(hotmap2())
```

```{r}
renderPlot(hotplo2(), height = 450, width = 900)
```

## Analyses by watershed {.tabset .tabset-pills}

```{r}
column(12, 
       column(4, 
              selectInput('wshsel', 'Select watershed:', choices = unique(dwdat$Watershed))
       ),
       column(4,
               selectInput('varsel', 'Select constituent:', choices = c(tops, nutrs), selected = 'ENT')
       ), 
       column(4, 
              renderUI({
      
                # input
                spaflt <- wshpardat()
                stas <- unique(wshpardat()$StationCode)
                
                pickerInput(inputId = "stasel", label = 'Select stations:', choices = stas,
                  options = list(`actions-box` = TRUE, size = 20), selected = stas, multiple = TRUE)      
                
              })
        )
)
column(12, 
       column(4, 
              selectInput('logsel', 'Log scale?', choices = c(F, T))
       ), 
       column(4, 
              renderUI({
                
                req(nrow(stawshpardat())> 0)
                
                # inputs
                stawshpardat <- stawshpardat()
            
                # get range, ave for selector
                qnts <- seq(0, 1, by = 0.1)
                qntval <- stawshpardat %>%
                  pull(Result) %>% 
                  quantile(probs = qnts, na.rm = T) %>%
                  round(2) %>% 
                  as.list()
                
                selectInput('thrsel', 'Select threshold as quantile:', choices = qntval, selected = qntval[10])
                # sliderInput('thrsel', 'Select threshold:', min = rngval[1], max = rngval[2], value = qntval, width = '600px')
                
              })
        )
)
```

### Observed

`r renderText({thrtx()})`

```{r}
output$obsp1 <- renderPlotly({obsp1()})
output$obsp2 <- renderPlotly({obsp2()})
output$obsp3 <- renderPlotly({obsp3()})
plotlyOutput('obsp1', height = "400px", width = "900px")
plotlyOutput('obsp2', height = "400px", width = "900px")
plotlyOutput('obsp3', height = "400px", width = "900px")
```
